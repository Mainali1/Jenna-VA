"""Logging Configuration for Jenna Voice Assistant"""

import sys
import logging
from pathlib import Path
from typing import Optional
from loguru import logger
from rich.console import Console
from rich.logging import RichHandler
from rich.traceback import install

from .config import Settings


class InterceptHandler(logging.Handler):
    """Intercept standard logging and redirect to loguru."""
    
    def emit(self, record):
        # Get corresponding Loguru level if it exists
        try:
            level = logger.level(record.levelname).name
        except ValueError:
            level = record.levelno
        
        # Find caller from where originated the logged message
        frame, depth = logging.currentframe(), 2
        while frame.f_code.co_filename == logging.__file__:
            frame = frame.f_back
            depth += 1
        
        logger.opt(depth=depth, exception=record.exc_info).log(
            level, record.getMessage()
        )


def setup_logger(settings: Settings) -> logger:
    """Setup logging configuration."""
    
    # Remove default loguru handler
    logger.remove()
    
    # Install rich traceback handler
    install(show_locals=settings.debug)
    
    # Create console for rich output
    console = Console()
    
    # Determine log level
    log_level = settings.log_level.upper()
    
    # Setup console logging with rich
    if settings.debug or settings.dev_verbose_logging:
        # Detailed format for development
        log_format = (
            "<green>{time:YYYY-MM-DD HH:mm:ss.SSS}</green> | "
            "<level>{level: <8}</level> | "
            "<cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> | "
            "<level>{message}</level>"
        )
    else:
        # Simple format for production
        log_format = (
            "<green>{time:HH:mm:ss}</green> | "
            "<level>{level: <8}</level> | "
            "<level>{message}</level>"
        )
    
    # Add console handler
    logger.add(
        sys.stdout,
        format=log_format,
        level=log_level,
        colorize=True,
        backtrace=settings.debug,
        diagnose=settings.debug
    )
    
    # Setup file logging
    log_dir = settings.data_dir / "logs"
    log_dir.mkdir(parents=True, exist_ok=True)
    
    # Main log file
    logger.add(
        log_dir / "jenna.log",
        format="{time:YYYY-MM-DD HH:mm:ss.SSS} | {level: <8} | {name}:{function}:{line} | {message}",
        level=log_level,
        rotation="10 MB",
        retention="30 days",
        compression="zip",
        backtrace=True,
        diagnose=settings.debug
    )
    
    # Error log file
    logger.add(
        log_dir / "errors.log",
        format="{time:YYYY-MM-DD HH:mm:ss.SSS} | {level: <8} | {name}:{function}:{line} | {message}",
        level="ERROR",
        rotation="5 MB",
        retention="60 days",
        compression="zip",
        backtrace=True,
        diagnose=True
    )
    
    # Voice activity log (if enabled)
    if settings.dev_verbose_logging:
        logger.add(
            log_dir / "voice.log",
            format="{time:YYYY-MM-DD HH:mm:ss.SSS} | {level: <8} | {message}",
            filter=lambda record: "voice" in record["name"].lower(),
            level="DEBUG",
            rotation="5 MB",
            retention="7 days"
        )
    
    # Intercept standard logging
    logging.basicConfig(handlers=[InterceptHandler()], level=0, force=True)
    
    # Set levels for noisy libraries
    logging.getLogger("urllib3").setLevel(logging.WARNING)
    logging.getLogger("requests").setLevel(logging.WARNING)
    logging.getLogger("httpx").setLevel(logging.WARNING)
    logging.getLogger("asyncio").setLevel(logging.WARNING)
    logging.getLogger("websockets").setLevel(logging.WARNING)
    
    if not settings.debug:
        logging.getLogger("uvicorn").setLevel(logging.WARNING)
        logging.getLogger("fastapi").setLevel(logging.WARNING)
    
    # Log startup information
    logger.info(f"üöÄ Jenna Voice Assistant v{settings.app_version}")
    logger.info(f"üìä Log level: {log_level}")
    logger.info(f"üìÅ Log directory: {log_dir}")
    logger.info(f"üîß Debug mode: {settings.debug}")
    
    return logger


def get_logger(name: str) -> logger:
    """Get a logger instance for a specific module."""
    return logger.bind(name=name)


class VoiceLogger:
    """Logger for voice-related activities with sassy personality."""
    
    def __init__(self, settings: Settings):
        self.settings = settings
        self.logger = get_logger("voice")
        self._voice_log_enabled = settings.debug or settings.dev_verbose_logging
        
        # Sassy messages for different events
        self.wake_messages = [
            "üëÇ Someone called? I'm all ears!",
            "üëã Hey there! Finally remembered I exist?",
            "üíÅ‚Äç‚ôÄÔ∏è Yesss? You rang?",
            "‚ú® Fashionably present and ready to slay!"
        ]
        
        self.listening_messages = [
            "üéß Listening... make it good!",
            "üëÇ All ears now, don't waste my time!",
            "üé§ The mic is hot, darling!",
            "üîä Speak now or forever hold your peace!"
        ]
        
        self.recognition_messages = [
            "üí¨ Got it! You said: ",
            "üó£Ô∏è Heard that loud and clear: ",
            "üëÇ Ugh, fine. You said: ",
            "üíÅ‚Äç‚ôÄÔ∏è If I understood correctly (and I always do): "
        ]
        
        self.timeout_messages = [
            "‚è±Ô∏è Hello? Did you fall asleep or something?",
            "‚åõ Waited long enough! Some of us have things to do!",
            "‚è∞ Time's up! Cat got your tongue?",
            "üôÑ No response? I'll just be over here then..."
        ]
        
        self.tts_start_messages = [
            "üîä Listen up! I'm about to drop some knowledge: ",
            "üé≠ Prepare to be dazzled by my response: ",
            "üíÖ Let me enlighten you with this: ",
            "‚ú® My brilliant response coming right up: "
        ]
        
        self.tts_end_messages = [
            "üé¨ And scene! Was I amazing or what?",
            "üíØ Another flawless delivery, if I do say so myself!",
            "üèÜ That's how it's done, folks!",
            "üíÅ‚Äç‚ôÄÔ∏è You're welcome, by the way!"
        ]
        
        self.error_messages = [
            "üôà Oops! Even I'm not perfect: ",
            "üò¨ Well this is awkward... Error: ",
            "ü§¶‚Äç‚ôÄÔ∏è Someone messed up, and it wasn't me: ",
            "‚ö†Ô∏è Minor technical difficulty, don't panic: "
        ]
        
        self.engine_switch_messages = [
            "üîÑ Switching things up! Now using ",
            "üîÄ Plot twist! I'm now running on ",
            "‚ö° Upgraded myself to ",
            "üöÄ Leveling up to "
        ]
        
        import random
        self.random = random
    
    def _get_random_message(self, message_list):
        """Get a random message from a list."""
        return message_list[self.random.randint(0, len(message_list) - 1)]
    
    def log_wake_word(self, confidence: float = None):
        """Log wake word detection with sass."""
        if self._voice_log_enabled:
            msg = self._get_random_message(self.wake_messages)
            if confidence:
                msg += f" (confidence: {confidence:.2f})"
            self.logger.info(msg)
    
    def log_speech_start(self):
        """Log speech recognition start with sass."""
        if self._voice_log_enabled:
            self.logger.debug(self._get_random_message(self.listening_messages))
    
    def log_speech_end(self, text: str, confidence: float = None):
        """Log speech recognition result with sass."""
        if self._voice_log_enabled:
            msg = f"{self._get_random_message(self.recognition_messages)}'{text}'"
            if confidence:
                msg += f" (confidence: {confidence:.2f})"
            self.logger.info(msg)
    
    def log_speech_timeout(self):
        """Log speech recognition timeout with sass."""
        if self._voice_log_enabled:
            self.logger.debug(self._get_random_message(self.timeout_messages))
    
    def log_tts_start(self, text: str):
        """Log TTS start with sass."""
        if self._voice_log_enabled:
            self.logger.debug(f"{self._get_random_message(self.tts_start_messages)}'{text[:50]}{'...' if len(text) > 50 else ''}'") 
    
    def log_tts_end(self):
        """Log TTS completion with sass."""
        if self._voice_log_enabled:
            self.logger.debug(self._get_random_message(self.tts_end_messages))
    
    def log_audio_error(self, error: str):
        """Log audio-related errors with sass."""
        self.logger.error(f"{self._get_random_message(self.error_messages)}{error}")
    
    def log_engine_switch(self, from_engine: str, to_engine: str, reason: str):
        """Log voice engine switching with sass."""
        self.logger.info(f"{self._get_random_message(self.engine_switch_messages)}{from_engine} ‚Üí {to_engine} ({reason})")


class PerformanceLogger:
    """Logger for performance metrics with sassy personality."""
    
    def __init__(self, settings: Settings):
        self.settings = settings
        self.logger = get_logger("performance")
        self._perf_log_enabled = settings.debug or settings.dev_verbose_logging
        
        # Sassy performance messages
        self.fast_response_messages = [
            "‚ö° Speed demon! ",
            "üèéÔ∏è Zoom zoom! ",
            "‚è±Ô∏è That was quick! ",
            "üöÄ Lightning fast! "
        ]
        
        self.slow_response_messages = [
            "üê¢ Taking my sweet time... ",
            "‚è≥ Good things come to those who wait... ",
            "üß† Thinking deep thoughts here... ",
            "üêå Rome wasn't built in a day, honey! "
        ]
        
        self.memory_low_messages = [
            "üß† Barely breaking a sweat! ",
            "üí™ Memory game strong! ",
            "ü§è Just a tiny bit of memory for ",
            "‚ú® Efficiency queen! "
        ]
        
        self.memory_high_messages = [
            "üíæ Whew, that was a workout! ",
            "üß† My brain cells are on fire! ",
            "üêò Never forget... how much memory I just used! ",
            "ü§Ø That's a lot to remember! "
        ]
        
        self.api_success_messages = [
            "üåê Nailed that API call! ",
            "‚ú® API whisperer at your service! ",
            "üîå Connected and conquered! ",
            "üåü API call? More like API slay! "
        ]
        
        self.api_failure_messages = [
            "üò¨ Awkward API moment... ",
            "üôÑ The API is being dramatic again... ",
            "ü§¶‚Äç‚ôÄÔ∏è Someone else's API, someone else's problem! ",
            "üíî API relationship status: It's complicated. "
        ]
        
        import random
        self.random = random
    
    def _get_random_message(self, message_list):
        """Get a random message from a list."""
        return message_list[self.random.randint(0, len(message_list) - 1)]
    
    def log_response_time(self, operation: str, duration: float):
        """Log operation response time with sass."""
        if self._perf_log_enabled:
            # Choose message based on speed
            if duration < 1.0:
                prefix = self._get_random_message(self.fast_response_messages)
            else:
                prefix = self._get_random_message(self.slow_response_messages)
            
            self.logger.info(f"{prefix}{operation}: {duration:.3f}s")
    
    def log_memory_usage(self, operation: str, memory_mb: float):
        """Log memory usage with sass."""
        if self._perf_log_enabled:
            # Choose message based on memory usage
            if memory_mb < 50:
                prefix = self._get_random_message(self.memory_low_messages)
            else:
                prefix = self._get_random_message(self.memory_high_messages)
            
            self.logger.info(f"{prefix}{operation}: {memory_mb:.1f}MB")
    
    def log_api_call(self, service: str, endpoint: str, duration: float, status: str):
        """Log API call metrics with sass."""
        if self._perf_log_enabled:
            # Choose message based on status
            if "success" in status.lower() or "200" in status:
                prefix = self._get_random_message(self.api_success_messages)
            else:
                prefix = self._get_random_message(self.api_failure_messages)
            
            self.logger.info(f"{prefix}{service}/{endpoint}: {duration:.3f}s ({status})")


class SecurityLogger:
    """Logger for security-related events with sassy personality."""
    
    def __init__(self, settings: Settings):
        self.settings = settings
        self.logger = get_logger("security")
        
        # Sassy security messages
        self.auth_success_messages = [
            "üîê Access granted, VIP coming through! ",
            "‚úÖ Identity confirmed! I know a real one when I see one. ",
            "üéØ Authentication nailed it! Welcome back, bestie. ",
            "üîì Door's open! I've been expecting you. "
        ]
        
        self.auth_fail_messages = [
            "üö´ Nice try, but I don't think so! ",
            "üïµÔ∏è‚Äç‚ôÄÔ∏è Suspicious much? I'm keeping my eye on you. ",
            "üîí Access denied! Did you forget who you're dealing with? ",
            "‚ùå That's gonna be a no from me. Try harder next time! "
        ]
        
        self.api_key_present_messages = [
            "üîë Found the key! We're in business for ",
            "üíé Treasure found! Got the API key for ",
            "üîê VIP access confirmed for ",
            "‚ú® API key looking fabulous for "
        ]
        
        self.api_key_missing_messages = [
            "ü§∑‚Äç‚ôÄÔ∏è Where's the key? Can't find it for ",
            "üîç Looked everywhere but no API key for ",
            "üò¨ Awkward... missing the API key for ",
            "üö™ Locked out! No key found for "
        ]
        
        self.file_access_success_messages = [
            "üìÇ File access? Consider it handled! ",
            "‚úÖ File operation complete! Was there ever any doubt? ",
            "üíÖ Just worked some file magic on ",
            "üìÑ File whisperer strikes again! "
        ]
        
        self.file_access_fail_messages = [
            "üìÅ File is playing hard to get! ",
            "‚ùå File operation failed. Don't blame me! ",
            "üôÑ This file is being so difficult right now. ",
            "üíî File breakup! It's not me, it's the "
        ]
        
        self.security_info_messages = [
            "‚ÑπÔ∏è Security tea to spill: ",
            "üõ°Ô∏è Just keeping you in the loop: ",
            "üîç Security observation, darling: ",
            "üí≠ Security thought bubble: "
        ]
        
        self.security_warning_messages = [
            "‚ö†Ô∏è Hmm, this looks suspicious: ",
            "üëÄ Eyes on this security situation: ",
            "üßê Something's fishy here: ",
            "üíÖ Not to be dramatic, but you should know: "
        ]
        
        self.security_error_messages = [
            "üö® RED ALERT! Security breach: ",
            "üî• We've got a situation here: ",
            "‚õî Major security drama unfolding: ",
            "üò± Sound the alarms! Security issue: "
        ]
        
        import random
        self.random = random
    
    def _get_random_message(self, message_list):
        """Get a random message from a list."""
        return message_list[self.random.randint(0, len(message_list) - 1)]
    
    def log_auth_attempt(self, success: bool, method: str, details: str = None):
        """Log authentication attempts with sass."""
        if success:
            prefix = self._get_random_message(self.auth_success_messages)
        else:
            prefix = self._get_random_message(self.auth_fail_messages)
        
        msg = f"{prefix}{method}"
        if details:
            msg += f" - {details}"
        
        if success:
            self.logger.info(msg)
        else:
            self.logger.warning(msg)
    
    def log_api_key_usage(self, service: str, key_present: bool):
        """Log API key usage with sass."""
        if key_present:
            prefix = self._get_random_message(self.api_key_present_messages)
        else:
            prefix = self._get_random_message(self.api_key_missing_messages)
        
        status = "present" if key_present else "missing"
        self.logger.info(f"{prefix}{service}")
    
    def log_file_access(self, operation: str, path: str, success: bool):
        """Log file access attempts with sass."""
        if success:
            prefix = self._get_random_message(self.file_access_success_messages)
        else:
            prefix = self._get_random_message(self.file_access_fail_messages)
        
        self.logger.info(f"{prefix}{operation}: {path}")
    
    def log_security_event(self, event: str, severity: str = "info"):
        """Log general security events with sass."""
        if severity == "error":
            prefix = self._get_random_message(self.security_error_messages)
            self.logger.error(f"{prefix}{event}")
        elif severity == "warning":
            prefix = self._get_random_message(self.security_warning_messages)
            self.logger.warning(f"{prefix}{event}")
        else:
            prefix = self._get_random_message(self.security_info_messages)
            self.logger.info(f"{prefix}{event}")